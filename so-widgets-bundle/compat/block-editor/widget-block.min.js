!async function(e,t,i,o,s){const n=i.createElement,r=e.registerBlockType,a=s.BlockControls,{useMemo:d}=i,{ToolbarGroup:l,ToolbarButton:c,Placeholder:w,Button:g,Spinner:u}=o,{__:b,sprintf:m}=t,{updateCategory:p}=e,f=e=>{let t="";return e.hasOwnProperty("responseJSON")?t=e.responseJSON.message:e.hasOwnProperty("responseText")&&(t=e.responseText),t},k=["sowb/siteorigin-widget-googlemap-widget","sowb/siteorigin-widget-icon-widget"],v=e=>e.icon?e.icon.trim().startsWith("<svg")?n("span",{className:"widget-icon so-widget-icon so-block-editor-icon",dangerouslySetInnerHTML:{__html:e.icon}}):n("img",{className:"widget-icon so-widget-icon so-block-editor-icon",src:e.icon,alt:e.name}):n("span",{className:"widget-icon so-widget-icon so-block-editor-icon",dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.defaultIcon}}),y=(e,t,i,o=!1,s=!1,n)=>{if(n.current&&"function"==typeof n.current.abort&&(n.current.abort(),n.current=null),t)return;i({loadingWidgetPreview:!0,widgetPreviewHtml:null});const r="object"==typeof wp.data.select("core/editor")&&"object"==typeof wp.data.dispatch("core/editor");r&&wp.data.dispatch("core/editor").lockPostSaving();const a=jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/previews",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{anchor:e.attributes.anchor,widgetClass:s,widgetData:o||(e.attributes.widgetData||{})}});n.current=a,a.done(t=>{let o=!1;t.html&&(o=!!k.includes(e.name)||(e=>{const t=jQuery("<div>"+e+"</div>");let i=!1;const o=t.find("div:first-of-type");return o.length>0&&(""!==o.text().trim()||o.find("img, video, a").length>0)&&(i=!0),t.remove(),i})(t.html)),o||(t.html='<div class="so-widget-preview-empty">'+b("No widget preview available.","so-widgets-bundle")+"</div>"),i({widgetPreviewHtml:t.html,previewInitialized:!1}),e.setAttributes({widgetMarkup:t.html,widgetIcons:t.widgetIcons})}).fail(e=>{e&&"abort"===e.statusText||i({widgetFormHtml:"<div>"+f(e)+"</div>"})}).always(()=>{n.current=null,r&&wp.data.dispatch("core/editor").unlockPostSaving(),i({loadingWidgetPreview:!1})})},h=({props:e,widget:t})=>d(()=>n(j,{...e,widget:t}),[e,t]),S=async(e,t,i)=>{const o=sowbGetBlockForm(e.clientId);if(0===o.length||t.formInitialized)return;sowbMaybeSetupSiteEditorAssets();o.siblings(".siteorigin-widget-preview").find("> a").on("click",function(e){e.stopImmediatePropagation(),i({editing:!1,previewInitialized:!1,widgetPreviewHtml:!1})}),o.data("backupDisabled",!0),e.attributes.widgetData?sowbForms.setWidgetFormValues(o,e.attributes.widgetData):e.setAttributes({widgetData:sowbForms.getWidgetFormValues(o)}),o.sowSetupForm(),o.on("change",function(){if(o.data("sow-form-setup")){var t=sowbForms.getWidgetFormValues(o);e.setAttributes({widgetData:t});var s=o.data("sowb-preview-timer");s&&clearTimeout(s);var n=setTimeout(()=>{y(e,!1,i,t,e.widget.class,activeRequestRef)},300);o.data("sowb-preview-timer",n)}}),i({formInitialized:!0})},B=()=>{if(sowbSiteEditorCanvas&&0!==sowbSiteEditorCanvas.length)try{const e=sowbSiteEditorCanvas[0].contentWindow;e&&e.postMessage({action:"sowbBlockFormInit"},"*")}catch(e){console.error("SiteOrigin Widgets: Failed to send postMessage to iframe:",e)}};function j(e){const t={editing:void 0===e.attributes.widgetData,formInitialized:!1,loadingForm:!1,loadingWidgetPreview:!1,previewInitialized:!1,widgetFormHtml:"",widgetPreviewHtml:"",widgetSettingsChanged:!1,previewDebounceTimer:null},[o,r]=i.useState({...t,isStillMounted:!0,devModeRemount:!1}),d=e=>{r(t=>({...t,...e}))},g=i.useRef(!0),m=i.useRef(null);i.useEffect(()=>{e.attributes.widgetClass||e.setAttributes({widgetClass:e.widget.class})},[]);const p=()=>{const{editing:t,widgetFormHtml:i,loadingForm:s,loadingWidgetPreview:n}=o,{attributes:r}=e;if(t||!r.widgetData){return void(!i.length&&!s&&(d({loadingForm:!0}),jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/forms",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)},data:{widgetClass:e.widget.class,widgetData:r.widgetData}}).done(e=>{d({widgetFormHtml:e}),setTimeout(()=>{d({loadingForm:!1,formInitialized:!1})},0)}).fail(e=>{d({widgetFormHtml:"<div>"+f(e)+"</div>"})})))}!n&&!t&&(e.setAttributes({widgetMarkup:null,widgetIcons:null}),y(e,o.loadingWidgetPreview,d,!1,e.widget.class,m))};i.useEffect(()=>(d({...t,isStillMounted:!0}),p(),()=>{g.current=!1,d({...t,isStillMounted:!1,devModeRemount:!0})}),[]),i.useEffect(()=>{o.isStillMounted&&p()},[e.attributes.widgetData,o.editing]);const k=s&&s.useBlockProps?s.useBlockProps():{},{editing:v,widgetFormHtml:h,loadingForm:j,widgetPreviewHtml:E,loadingWidgetPreview:I,previewInitialized:C}=o,{attributes:M}=e;return n("div",k,v||!M.widgetData?[!!h&&n(a,{key:"controls"},n(l,{label:b("Widget Preview Controls","so-widgets-bundle")},n(c,{label:b("Preview widget.","so-widgets-bundle"),onClick:()=>d({editing:!1}),icon:"visibility"}))),n(w,{key:"placeholder",className:"so-widget-block-form siteorigin-widget-form wp-core-ui",label:e.widget.name,instructions:e.widget.description},j?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(u))):n("div",{className:"so-widget-block-container siteorigin-widget-form-main wp-core-ui",dangerouslySetInnerHTML:{__html:h},ref:()=>{S(e,o,d).then(()=>{sowbBlockEditorAdmin.wpScriptDebug&&!o.devModeRemount||B()})}}))]:[n(a,{key:"controls"},n(l,{label:b("Widget Edit Controls","so-widgets-bundle")},n(c,{label:b("Edit widget.","so-widgets-bundle"),onClick:()=>d({editing:!0,loadingForm:!1,widgetFormHtml:"",formInitialized:!1}),icon:"edit"}))),n("div",{key:"preview",className:"so-widget-preview-container"},I?n("div",{className:"so-widgets-spinner-container"},n("span",null,n(u))):n("div",{dangerouslySetInnerHTML:{__html:E},ref:()=>{C||(jQuery(window.sowb).trigger("setup_widgets",{preview:!0}),d({previewInitialized:!0}))}}))])}r("sowb/widget-block",{apiVersion:3,title:b("SiteOrigin Widgets Block","so-widgets-bundle"),description:b("This block is intended as a legacy placeholder.","so-widgets-bundle"),attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"},widgetNotFound:{type:"boolean"}},supports:{inserter:!1},icon:function(){return n("span",{className:"widget-icon so-widget-icon so-block-editor-icon so-widget-icon-default"})},edit:function(e){const[t,o]=i.useState(!1),[s,r]=i.useState(!0);return i.useEffect(()=>{I().then(e=>{o(e),r(!1)})},[]),e.attributes.widgetNotFound?n(w,{label:b("SiteOrigin Widget","so-widgets-bundle"),className:"so-widget-block-form"},n("p",null,m(b("The widget for %s cannot be found.","so-widgets-bundle"),e.attributes.widgetClass))):s?n("div",{className:"so-widget-block-form so-widgets-spinner-container"},n("span",null,n(u))):n("div",{className:"so-widget-block-form"},n(w,{label:b("Legacy SiteOrigin Widget","so-widgets-bundle")},n("p",{dangerouslySetInnerHTML:{__html:sowbBlockEditorAdmin.legacyNotice}}),t?n(g,{isPrimary:!0,onClick:()=>{r(!0),setTimeout(()=>{sowbBlockEditorAdmin.consent=!0,sowbBlockEditorAdmin.consentGiven=!0,sowbMigrateOldBlocks()},0),jQuery.post(window.top.ajaxurl,{action:"so_widgets_block_migration_notice_consent",nonce:sowbBlockEditorAdmin.migrationNotice})}},b("Migrate to New Block Format","so-widgets-bundle")):n("span",null,b("Please contact your site administrator to migrate this block.","so-widgets-bundle"))))},save:function(){return null}});let E=null;const I=()=>(null!==E||(E=new Promise((e,t)=>{jQuery.post({url:sowbBlockEditorAdmin.restUrl+"sowb/v1/widgets/permission",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",sowbBlockEditorAdmin.nonce)}}).done(t=>{e(t)}).fail(t=>{console.error("Failed to check admin permissions:",t),e(!1)})})),E),C={},M=[...Object.values(sowbBlockEditorAdmin.widgets)];await Promise.all(Object.entries(M).map(async([e,t])=>{(async(e,t)=>{if(e.blockName)return void 0!==e.manuallyRegister&&e.manuallyRegister?(C[e.blockName]=e,void delete M[t]):void 0;delete M[t]})(t,e)})),await soRegisterWidgetBlocks(C),Object.entries(C).forEach(([e,t])=>{t.blockName&&wp.hooks.addFilter("blocks.registerBlockType","sowb/"+t.blockName,function(e,i){return i!=="sowb/"+t.blockName?e:{...e,icon:v(t),keywords:t.keywords?t.keywords:"",category:"siteorigin",supports:{html:!1,anchor:!0},edit:e=>n(h,{props:e,widget:t})}})});M.forEach(e=>{e.blockName&&r("sowb/"+e.blockName,{apiVersion:3,title:e.name,description:e.description,icon:v(e),category:"siteorigin",keywords:e.keywords?e.keywords:"",supports:{html:!1,anchor:!0},attributes:{widgetClass:{type:"string"},anchor:{type:"string"},widgetData:{type:"object"},widgetMarkup:{type:"string"},widgetIcons:{type:"array"}},edit:t=>n(h,{props:t,widget:e}),save:function(e){return null}})}),p("siteorigin",{icon:n("img",{src:sowbBlockEditorAdmin.categoryIcon,alt:b("SiteOrigin Widgets Bundle Blocks Category","so-widgets-bundle"),style:{height:"20px",width:"20px"}})}),window.frameElement&&(sowbSiteEditorCanvas=window.frameElement,sowbMaybeSetupSiteEditorAssets())}(window.wp.blocks,window.wp.i18n,window.wp.element,window.wp.components,window.wp.blockEditor);let sowbSiteEditorCanvas=!1;const sowbGetBlockForm=e=>(!1===sowbSiteEditorCanvas&&(sowbSiteEditorCanvas=jQuery(".edit-site-visual-editor__editor-canvas")),0===sowbSiteEditorCanvas.length?jQuery('[data-block="'+e+'"]').find(".siteorigin-widget-form-main"):sowbSiteEditorCanvas.contents().find('[data-block="'+e+'"]').find(".siteorigin-widget-form-main")),sowbCanvasCloneElements=["#jquery-core-js","#jquery-migrate-js","#editor-js-after","#wp-tinymce-js","#wp-block-library-js-before","#jquery-ui-core-js","#jquery-ui-mouse-js","#jquery-ui-slider-js","#jquery-ui-sortable-js","#jquery-ui-resizable-js","#jquery-ui-draggable-js","#wplink-js-extra","#wplink-js","#buttons-css","#dashicons-css",'link[href*="wp-admin/load-styles.php"]',"#tmpl-attachment-details","#tmpl-attachment-display-settings","#tmpl-attachment","#tmpl-embed-link-settings","#tmpl-image-editor","#tmpl-media-frame","#tmpl-media-modal","#tmpl-media-selection","#tmpl-uploader-editor","#tmpl-uploader-inline","#tmpl-uploader-status-error","#tmpl-uploader-status","#tmpl-uploader-window","#editor-buttons-css","#forms-css","#media-views-css","#select2-css","#siteorigin-widget-admin-css","#siteorigin-widget-admin-js-extra","#siteorigin-widget-admin-js","#so-widgets-bundle-tpl-image-search-dialog","#so-widgets-bundle-tpl-image-search-result-sponsored","#so-widgets-bundle-tpl-image-search-result","#sowb-pikaday-js","#sowb-pikaday-css","#wp-color-picker-alpha-js","#so-autocomplete-field-js","#so-code-field-js","#so-date-range-field-js","#so-date-range-field-css","#so-icon-field-js","#so-image-radio-field-js","#so-image-size-js","#so-media-field-js","#so-multi-measurement-field-js","#so-multiple-image-shape-field-js","#so-multiple-media-field-js","#so-order-field-js","#so-posts-selector-field-js","#so-presets-field-js","#so-select-field-js","#so-tabs-field-js","#so-tinymce-field-js","#so-toggle-field-js"],sowbCloneElementsToCanvas=e=>{for(const t of sowbCanvasCloneElements){const i=jQuery(t);if(0===i.length)continue;const o=i[0]&&i[0].outerHTML;o&&(0===e.find(t).length&&e.append(o))}};let sowbSiteEditorAssetsSetup=!1;const sowbMaybeSetupSiteEditorAssets=()=>{if(!sowbSiteEditorCanvas||0===sowbSiteEditorCanvas.length||sowbSiteEditorAssetsSetup)return void(sowbSiteEditorAssetsSetup=!0);sowbSiteEditorAssetsSetup=!0;const e=void 0!==sowbSiteEditorCanvas[0]?sowbSiteEditorCanvas[0]:sowbSiteEditorCanvas,t=jQuery(e.contentDocument).find("body");sowbCloneElementsToCanvas(t),void 0===e.contentWindow.ajaxurl&&(e.contentWindow.ajaxurl=window.top.ajaxurl)},sowbFindLegacyBlocks=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{"sowb/widget-block"===t.name&&e.push(t)}),e}return"sowb/widget-block"===t.name&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindLegacyBlocks(t.innerBlocks)),e},[]),sowbIsWidgetActive=e=>sowbBlockEditorAdmin.widgets.find(t=>t.class===e);let sowbMigrateBlockSubscribe=!1,sowbMigrationInProgress=!1;const sowbMigrateOldBlocks=()=>{if(!0===sowbMigrationInProgress)return;const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const t=sowbFindLegacyBlocks(e);if(0!==t.length){if(sowbBlockEditorAdmin.consent){sowbMigrationInProgress=!0;try{t.forEach(e=>{try{if(!sowbIsWidgetActive(e.attributes.widgetClass)){const t={...e.attributes};return t.widgetNotFound=!0,void wp.data.dispatch("core/block-editor").updateBlock(e.clientId,{attributes:t})}const t=wp.blocks.createBlock("sowb/"+e.attributes.widgetClass.toLowerCase().replace(/_/g,"-"),e.attributes);t&&wp.data.dispatch("core/block-editor").replaceBlock(e.clientId,t)}catch(e){console.error("SiteOrigin Widget Block migration failed:",e)}})}finally{setTimeout(()=>{sowbMigrationInProgress=!1},100)}return!sowbBlockEditorAdmin.consentGiven&&sowbRemoveLegacyWidgetBlock()}"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()}},sowbRemoveLegacyWidgetBlock=()=>(setTimeout(()=>{"function"==typeof sowbMigrateBlockSubscribe&&sowbMigrateBlockSubscribe()},0),!1),sowbIsMissingBlockSowb=e=>"core/missing"===e.name&&e.isValid&&e.attributes&&e.attributes.originalName.startsWith("sowb/"),sowbFindInactiveBlock=e=>e.reduce((e,t)=>{if("core/widget-area"===t.name){return wp.data.select("core/block-editor").getBlocks(t.clientId).forEach(t=>{sowbIsMissingBlockSowb(t)&&e.push(t)}),e}return sowbIsMissingBlockSowb(t)&&e.push(t),t.innerBlocks&&t.innerBlocks.length>0&&e.push(...sowbFindInactiveBlock(t.innerBlocks)),e},[]);if(jQuery(function(e){if(!e("body.block-editor-page").length)return;sowbBlockEditorAdmin.consent&&(sowbMigrateBlockSubscribe=wp.data.subscribe(sowbMigrateOldBlocks));const t=wp.data.subscribe(()=>{const e=wp.data.select("core/block-editor").getBlocks();if(0===e.length)return;const i=sowbFindInactiveBlock(e);i.length&&(setTimeout(()=>{(e=>{e.forEach(e=>{const t=document.querySelector(`[data-block="${e.clientId}"] .block-editor-warning__message`);t&&(t.innerHTML=sprintf(wp.i18n.__('The "%s" block is currently not available. The plugin or theme that powers the block might be deactivated or not installed. You can leave it as is or remove it. %sRead our troubleshooting guide for more details%s.',"so-widgets-bundle"),`<strong>${e.attributes.originalName}</strong>`,'<a href="https://siteorigin.com/widgets-bundle/troubleshooting/" target="_blank" rel="noopener noreferrer">',"</a>"))})})(i)},0),t())})}),"undefined"!=typeof adminpage&&"widgets-php"!=adminpage&&"function"==typeof wp.data.select){let e=!1;wp.data.subscribe(function(){if(!e&&"object"==typeof wp.data.select("core/editor")&&wp.data.select("core/editor").isSavingPost()){e=!0;var t=setInterval(function(){if(!wp.data.select("core/editor").isSavingPost()&&!wp.data.select("core/editor").isAutosavingPost()&&wp.data.select("core/editor").didPostSaveRequestSucceed()){clearInterval(t);for(var i=!0,o=wp.data.select("core/block-editor").getBlocks(),s=0;s<o.length;s++)o[s].name.startsWith("sowb/")&&o[s].isValid&&($form=jQuery("#block-"+o[s].clientId).find(".so-widget-block-form"),sowbForms.validateFields($form,i)||(i=!1),$form.find(".siteorigin-widget-field-is-required input").on("change",function(){sowbForms.validateFields($form)}));e=!1}},250)}})}